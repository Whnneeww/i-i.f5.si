<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>MIDIファイル解析</title>
    <script src="https://cdn.rawgit.com/cifkao/midi-parser-js/master/dist/midi-parser.js"></script>
</head>
<body>
    <h1>MIDIファイル解析プログラム</h1>
    <input type="file" id="midiFile" accept=".midi,.mid">
    <button id="parseButton">解析する</button>
    <pre id="output"></pre>
    <button id="downloadButton" style="display: none;">JSONをダウンロード</button>

    <script>
        document.getElementById('parseButton').addEventListener('click', function() {
            const fileInput = document.getElementById('midiFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('MIDIファイルを選択してください。');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(evt) {
                const midiData = midiParser.parse(evt.target.result);
                let output = generateMidiList(midiData);
                document.getElementById('output').textContent = JSON.stringify(output, null, 2);
                document.getElementById('downloadButton').style.display = 'inline-block';
                document.getElementById('downloadButton').onclick = () => {
                    downloadData(JSON.stringify(output, null, 2), 'midi_output.json');
                };
            };
            reader.readAsArrayBuffer(file);
        });

        function generateMidiList(midiData) {
            const result = {
                tempo: midiData.header.getTempo(),
                tracks: []
            };
            midiData.tracks.forEach((track, trackIndex) => {
                const trackInfo = {
                    trackNumber: trackIndex + 1,
                    notes: []
                };
                track.forEach(note => {
                    if (note.type === 'note') {
                        trackInfo.notes.push({
                            pitch: note.noteNumber,
                            duration: note.duration,
                            startTime: note.startTime
                        });
                    }
                });
                result.tracks.push(trackInfo);
            });
            return result;
        }

        function downloadData(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
