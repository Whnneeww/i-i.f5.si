<!DOCTYPE html> 
<html> 
<head> 
  <title>MIDI ファイル解析</title> 
</head> 
<body> 
  <h1>MIDI ファイル解析</h1> 
  <input type="file" id="midiFile" accept=".mid, .midi"> 
  <button id="analyzeButton">解析</button> 
  <div id="results"></div> 
  <button id="downloadButton">ダウンロード</button> 
 
  <script> 
    const midiFile = document.getElementById('midiFile'); 
    const analyzeButton = document.getElementById('analyzeButton'); 
    const results = document.getElementById('results'); 
    const downloadButton = document.getElementById('downloadButton'); 
 
    analyzeButton.addEventListener('click', () => { 
      const file = midiFile.files[0]; 
      if (file) { 
        const reader = new FileReader(); 
        reader.onload = (event) => { 
          const midiData = event.target.result; 
          const notes = parseMidi(midiData); 
          displayResults(notes); 
          downloadButton.style.display = 'inline-block'; // ダウンロードボタンを表示 
        }; 
        reader.readAsArrayBuffer(file); 
      } 
    }); 
 
    function parseMidi(midiData) { 
      const music = new MusicJS.Music(); 
      const notes = []; 
      music.load(midiData).then(() => { 
        const score = music.getScore(); 
        score.tracks.forEach(track => { 
          track.notes.forEach(note => { 
            notes.push({ 
              note: note.pitch, 
              duration: note.duration, 
              time: note.startTime, 
              instrument: track.instrument, 
              tempo: score.tempo, 
            }); 
          }); 
        }); 
      }); 
      return notes; 
    } 
 
    function displayResults(notes) { 
      results.innerHTML = '<h2>解析結果</h2>'; 
      const table = document.createElement('table'); 
      table.innerHTML = ` 
        <thead> 
          <tr> 
            <th>音符</th> 
            <th>長さ</th> 
            <th>発音時間</th> 
            <th>楽器</th> 
            <th>テンポ</th> 
          </tr> 
        </thead> 
        <tbody> 
        </tbody> 
      `; 
      const tbody = table.querySelector('tbody'); 
      notes.forEach(note => { 
        const row = document.createElement('tr'); 
        row.innerHTML = ` 
          <td>${note.note}</td> 
          <td>${note.duration}</td> 
          <td>${note.time}</td> 
          <td>${note.instrument}</td> 
          <td>${note.tempo}</td> 
        `; 
        tbody.appendChild(row); 
      }); 
      results.appendChild(table); 
    } 
 
    downloadButton.addEventListener('click', () => { 
      const notes = parseMidi(midiData); // 読み込んだmidiDataを使用 
      const csvData = notes.map(note => `${note.note},${note.duration},${note.time},${note.instrument},${note.tempo}`).join('
'); 
      const blob = new Blob([csvData], { type: 'text/csv' }); 
      const link = document.createElement('a'); 
      link.href = URL.createObjectURL(blob); 
      link.download = 'midi_results.csv'; 
      link.click(); 
    }); 
  </script> 
  <script src="https://musicjs.github.io/MusicJS/dist/music.js"></script>  
</body> 
</html> 
 
